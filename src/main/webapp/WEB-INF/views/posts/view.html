<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title th:text="${post?.title ?: 'Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt'}"></title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .post-image {
      max-width: 100%;
      width: 100%;
      height: auto;
      border-radius: 5px;
      margin-bottom: 15px;
      display: block;
      object-fit: cover;
      max-height: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .content-wrapper {
      display: flex;
      justify-content: center;
      gap: 0px;
      flex-direction: column;
    }
    .content {
      flex: 1;
      padding: 10px 0;
    }
    .comment {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
      margin-bottom: 10px;
    }
    .comment p {
      margin: 5px 0;
    }
    .comment-meta {
      font-size: 0.9em;
      color: #777;
    }
    .button, .like-button, .comment-button {
      background-color: #5cb85c;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      text-decoration: none;
      display: inline-block;
      cursor: pointer;
    }
    .button:hover, .like-button:hover, .comment-button:hover {
      background-color: #449d44;
    }
    .like-button {
      background-color: #1e90ff; /* M√†u xanh blue */
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .like-button.liked {
      background-color: #ff4500; /* M√†u ƒë·ªè khi ƒë√£ th√≠ch */
    }
    .like-button.liked:hover {
      background-color: #e03e00;
    }
    .error {
      color: red;
      margin-bottom: 10px;
    }
    .like-section, .comment-section {
      margin-bottom: 20px;
    }
    .comment-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      margin-bottom: 10px;
      resize: vertical;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="content-wrapper" th:if="${post != null}">
    <img th:src="@{${post.imageUrl}}" alt="·∫¢nh b√†i vi·∫øt" class="post-image">
    <div class="content">
      <h1 th:text="${post.title}"></h1>
      <p th:text="${post.content}"></p>
      <p>T√°c gi·∫£: <span th:text="${post.author.username}"></span></p>
    </div>
  </div>
  <div th:if="${post == null}" class="error">
    <p>B√†i vi·∫øt kh√¥ng t·ªìn t·∫°i.</p>
  </div>

  <!-- Like Section -->
  <div class="like-section">
    <p><span id="like-count" th:text="${post != null and post.likes != null ? #lists.size(post.likes) : 0}"></span> l∆∞·ª£t th√≠ch</p>
    <div th:if="${currentUser != null and post != null}">
      <button class="like-button" th:classappend="${isLiked} ? 'liked' : ''" th:onclick="'toggleLike(this, ' + ${post.id} + ')'">
        <span class="like-icon">üëç</span>
        <span th:text="${isLiked} ? 'B·ªè th√≠ch' : 'Th√≠ch'"></span>
      </button>
    </div>
    <div th:if="${currentUser == null or post == null}">
      <p>Vui l√≤ng <a th:href="@{/login}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ th√≠ch b√†i vi·∫øt.</p>
    </div>
  </div>

  <!-- Comment Section -->
  <h2>B√¨nh lu·∫≠n</h2>
  <div class="comment-section">
    <div id="comment-list">
      <div th:if="${post != null and not #lists.isEmpty(post.comments)}">
        <div th:each="comment : ${post.comments}" class="comment">
          <p th:text="${comment.content}"></p>
          <div class="comment-meta">
            <p>B·ªüi: <span th:text="${comment.user.username}"></span> |
              V√†o: <span th:text="${#dates.format(comment.createdAt, 'dd/MM/yyyy HH:mm')}"></span></p>
          </div>
        </div>
      </div>
      <p th:unless="${post != null and not #lists.isEmpty(post.comments)}">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>
    </div>

    <h3>Th√™m b√¨nh lu·∫≠n</h3>
    <div th:if="${currentUser != null and post != null}">
      <textarea id="comment-input" class="comment-input" placeholder="Nh·∫≠p b√¨nh lu·∫≠n c·ªßa b·∫°n..." rows="3"></textarea>
      <button class="comment-button" th:onclick="'addComment(' + ${post.id} + ')'">B√¨nh lu·∫≠n</button>
    </div>
    <div th:if="${currentUser == null or post == null}">
      <p>Vui l√≤ng <a th:href="@{/login}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ th√™m b√¨nh lu·∫≠n.</p>
    </div>
  </div>

  <br>
  <a th:href="@{/posts}" class="button">Quay l·∫°i danh s√°ch</a>
</div>

<script th:inline="javascript">
  /* H√†m ƒë·ªÉ x·ª≠ l√Ω n√∫t Like */
  function toggleLike(button, postId) {
    fetch('/likes/toggle/' + postId, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
    }).then(response => {
      if (response.ok) {
        return response.text();
      }
      throw new Error('Network response was not ok');
    }).then(data => {
      const likeCountElement = document.getElementById('like-count');
      let likeCount = parseInt(likeCountElement.textContent);
      if (button.classList.contains('liked')) {
        button.classList.remove('liked');
        button.querySelector('span:last-child').textContent = 'Th√≠ch';
        likeCountElement.textContent = likeCount - 1;
      } else {
        button.classList.add('liked');
        button.querySelector('span:last-child').textContent = 'B·ªè th√≠ch';
        likeCountElement.textContent = likeCount + 1;
      }
    }).catch(error => {
      console.error('Error:', error);
    });
  }

  /* H√†m ƒë·ªÉ th√™m b√¨nh lu·∫≠n ƒë·ªông */
  function addComment(postId) {
    const commentInput = document.getElementById('comment-input');
    const content = commentInput.value.trim();

    if (content === '') {
      alert('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n!');
      return;
    }

    fetch('/comments', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: 'postId=' + postId + '&content=' + encodeURIComponent(content),
    }).then(response => {
      if (response.ok) {
        return response.text();
      }
      throw new Error('Network response was not ok');
    }).then(data => {
      const commentList = document.getElementById('comment-list');
      const noCommentMessage = commentList.querySelector('p');
      if (noCommentMessage) {
        noCommentMessage.remove();
      }

      const newComment = document.createElement('div');
      newComment.className = 'comment';
      newComment.innerHTML = `
        <p>${content}</p>
        <div class="comment-meta">
          <p>B·ªüi: <span>${currentUser.username}</span> | V√†o: <span>${new Date().toLocaleString('vi-VN')}</span></p>
        </div>
      `;
      commentList.insertBefore(newComment, commentList.firstChild);

      commentInput.value = '';
    }).catch(error => {
      console.error('Error:', error);
    });
  }

  /* L·∫•y th√¥ng tin currentUser t·ª´ Thymeleaf */
  const currentUser = {
    username: /*[[${currentUser != null ? currentUser.username : 'Anonymous'}]]*/ 'Anonymous'
  };
</script>
</body>
</html>